<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sentinel Camera Player</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        overflow: hidden;
        background: #020617;
        color: #e2e8f0;
        font-family: 'Space Grotesk', 'Segoe UI', system-ui, sans-serif;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      body::-webkit-scrollbar {
        display: none;
      }
      .frame {
        height: 100%;
        overflow: hidden;
        display: grid;
        place-items: center;
      }
      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #0f172a;
      }
      video:hover::-webkit-media-controls {
        display: none !important;
      }
      video:hover::-webkit-media-controls-panel {
        display: none !important;
      }
      .fallback {
        font-size: 14px;
        opacity: 0.85;
        padding: 16px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="frame">
      <video id="player" autoplay muted playsinline></video>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search)
      const initialSrc = params.get('src') || ''
      const wantControls = params.get('controls') === '1'
      const wantLL = params.get('ll') === '1'

      const video = document.getElementById('player')
      video.controls = wantControls

      const setFallback = (msg) => {
        document.body.innerHTML = `<div class="fallback">${msg}</div>`
      }

      let hls = null
      let currentSrc = ''

      const stopPlayback = () => {
        try {
          video.pause()
        } catch {}
        try {
          video.removeAttribute('src')
          video.load()
        } catch {}
        if (hls) {
          try {
            hls.destroy()
          } catch {}
          hls = null
        }
      }

      const startNative = (src) => {
        currentSrc = src
        video.src = src
        video.play().catch(() => {})
      }

      const startHlsJs = (src) => {
        currentSrc = src

        const config = {
          enableWorker: true,
          lowLatencyMode: wantLL,
          backBufferLength: 0,
          maxBufferLength: 6,
          maxMaxBufferLength: 12,
          maxBufferSize: 10 * 1000 * 1000,
          capLevelToPlayerSize: true,
          startLevel: 0,
          liveDurationInfinity: true,
          manifestLoadingMaxRetry: 4,
          manifestLoadingRetryDelay: 800,
          manifestLoadingMaxRetryTimeout: 8000,
          levelLoadingMaxRetry: 4,
          levelLoadingRetryDelay: 800,
          levelLoadingMaxRetryTimeout: 8000,
          fragLoadingMaxRetry: 4,
          fragLoadingRetryDelay: 800,
          fragLoadingMaxRetryTimeout: 8000
        }

        hls = new window.Hls(config)
        hls.attachMedia(video)
        hls.on(window.Hls.Events.MEDIA_ATTACHED, () => {
          try {
            hls.loadSource(src)
          } catch {}
        })

        hls.on(window.Hls.Events.ERROR, (event, data) => {
          if (!data || !data.fatal) return

          if (data.type === window.Hls.ErrorTypes.NETWORK_ERROR) {
            setTimeout(() => {
              try {
                hls.startLoad()
              } catch {}
            }, 1200)
            return
          }

          if (data.type === window.Hls.ErrorTypes.MEDIA_ERROR) {
            try {
              hls.recoverMediaError()
            } catch {}
            return
          }

          stopPlayback()
          setFallback('Stream unavailable.')
        })
      }

      const setSrc = (src) => {
        if (!src) {
          stopPlayback()
          setFallback('Missing stream URL.')
          return
        }
        if (src === currentSrc) return

        stopPlayback()

        if (video.canPlayType('application/vnd.apple.mpegurl')) {
          startNative(src)
          return
        }

        if (window.Hls && window.Hls.isSupported()) {
          startHlsJs(src)
          return
        }

        setFallback('HLS not supported in this browser.')
      }

      window.addEventListener('message', (event) => {
        const data = event?.data
        if (!data || typeof data !== 'object') return
        if (data.type === 'pause') {
          try {
            video.pause()
          } catch {}
          if (hls) {
            try {
              hls.stopLoad()
            } catch {}
          }
        } else if (data.type === 'play') {
          if (hls) {
            try {
              hls.startLoad()
            } catch {}
          }
          video.play().catch(() => {})
        } else if (data.type === 'setSrc') {
          setSrc(String(data.src || ''))
        }
      })

      window.addEventListener('pagehide', stopPlayback)
      window.addEventListener('beforeunload', stopPlayback)

      setSrc(initialSrc)
    </script>
  </body>
</html>
